var Component=require("montage/ui/component").Component,TextInput=require("ui/text-input").TextInput,logger=require("montage/core/logger").logger("autocomplete"),ResultsList=require("ui/autocomplete/results-list.reel/results-list").ResultsList,Popup=require("ui/popup/popup.reel").Popup,PressComposer=require("montage/composer/press-composer").PressComposer,RangeController=require("montage/core/range-controller").RangeController,KEY_UP=38,KEY_DOWN=40,KEY_RIGHT=39,KEY_ENTER=13,KEY_ESC=27,getElementPosition=function(e){var t=0,r=0,n=0,i=0;if(e.offsetParent)do t+=e.offsetLeft,r+=e.offsetTop,n+=e.offsetHeight,i+=e.offsetWidth;while(e=e.offsetParent);return{top:r,left:t,height:n,width:i}},Autocomplete=exports.Autocomplete=TextInput.specialize({constructor:{value:function(){this.super(),this.delay=500,this.minLength=2,this.classList.add("matte-InputText")}},hasTemplate:{value:!0},delegate:{value:null},textPropertyPath:{value:null},separator:{value:",",distinct:!0},_delay:{value:null},delay:{get:function(){return this._delay},set:function(e){e!==this._delay&&("string"==typeof e&&(e=parseInt(e,10)),this._delay=e)}},minLength:{value:null},_tokens:{value:null},tokens:{get:function(){return this._tokens},set:function(e){this._tokens=e,this._valueSyncedWithInputField=!1,this.needsDraw=!0},modify:function(e){this._tokens=e}},value:{get:function(){return this._value},set:function(e,t){this._value=e?e.trim():"";var r=this._value;if(r){var n=r.split(this.separator).map(function(e){return e.trim()});this.activeTokenIndex=this._findActiveTokenIndex(this.tokens,n),this._tokens=r.split(this.separator).map(function(e){return e.trim()})}else this.activeTokenIndex=0,this._tokens=[];if(t){if(this._valueSyncedWithInputField=!0,this.showPopup=!1,this._tokens.length&&this._tokens.length>0){var i=this._tokens[this.activeTokenIndex];if(i=i?i.trim():"",i.length>=this.minLength){var o=this;clearTimeout(this.delayTimer),this.delayTimer=setTimeout(function(){o.delayTimer=null,logger.isDebug&&logger.debug("SEARCH for ",i),o.performSearch(i)},this.delay)}}}else this.showPopup=!1,this._valueSyncedWithInputField=!1,this.needsDraw=!0}},overlayWidth:{value:null,enumerable:!1},delayTimer:{value:null,enumerable:!1},_loadingStatus:{value:!1,enumerable:!1},loadingStatus:{enumerable:!1,get:function(){return this._loadingStatus},set:function(e){this._loadingStatus=e,"loading"===this._loadingStatus&&(this.showPopup=!1),this.needsDraw=!0}},activeTokenIndex:{value:null},_findActiveTokenIndex:{enumerable:!1,value:function(e,t){if(null==e||null==t)return 0;var r=0,n=t.length;for(r=0;n>r;r++)if(e.length>r){if(e[r]===t[r])continue;break}return r}},_activeIndexes:{value:null,enumerable:!1},activeItemIndex:{enumerable:!1,get:function(){return this._activeIndexes&&this._activeIndexes.length>0?this._activeIndexes[0]:null},set:function(e){this._activeIndexes=null==e?[]:[e]}},_suggestedValue:{value:null},suggestedValue:{enumerable:!1,get:function(){return this._suggestedValue},set:function(e){if(this._suggestedValue=e,e){var t,r=this.tokens||[];t="string"==typeof e?e:this.textPropertyPath?e[this.textPropertyPath]:"",r[this.activeTokenIndex]=t,this.tokens=r,this.showPopup=!1}}},popup:{enumerable:!1,value:null},_showPopup:{value:null},showPopup:{enumerable:!1,get:function(){return this._showPopup},set:function(e){e!=this._showPopup&&(this._showPopup=e,this.needsDraw=!0)}},_suggestions:{value:null},suggestions:{enumerable:!1,get:function(){return this._suggestions},set:function(e){logger.isDebug&&logger.debug("got suggestions: ",e),this.loadingStatus="complete",this._suggestions=e,this.showPopup=e&&e.length>0}},resultsController:{enumerable:!1,value:null},resultsList:{enumerable:!1,value:null},performSearch:{enumerable:!1,value:function(e){this.delegate&&(this.resultsController.selectedIndexes=[],this.activeItemIndex=0,this.loadingStatus="loading",this.callDelegateMethod("ShouldGetSuggestions",this,e))}},_addEventListeners:{enumerable:!1,value:function(){this.element.addEventListener("keyup",this),this.element.addEventListener("input",this)}},_removeEventListeners:{enumerable:!1,value:function(){this.element.removeEventListener("keyup",this),this.element.removeEventListener("input",this)}},_getPopup:{enumerable:!1,value:function(){var e=this.popup;return e||(e=new Popup,e.content=this.resultsList,e.anchor=this.element,e.delegate=this,e.focusOnShow=!1,this.popup=e),this.popup}},willPositionPopup:{value:function(e){var t=e.anchorElement,r=getElementPosition(t);return{left:r.left,top:r.top+30}}},enterDocument:{value:function(e){e&&(this._addEventListeners(),this.element.classList.add("matte-Autocomplete"),this.resultsController=new RangeController,this.defineBinding("resultsController.content",{"<-":"suggestions"}),this.defineBinding("suggestedValue",{"<-":"resultsController.selection[0]"}),this.resultsList=new ResultsList,this.defineBinding("resultsList.contentController",{"<-":"resultsController"}),this.defineBinding("resultsList.activeIndexes",{"<-":"_activeIndexes"}),this.defineBinding("resultsList.textPropertyPath",{"<-":"textPropertyPath"}),this._getPopup())}},prepareForActivationEvents:{value:function(){var e=new PressComposer;this.addComposer(e)}},draw:{value:function(){this.super(),this._valueSyncedWithInputField||(this.tokens&&(this.value=this.tokens.join(this.separator)),this.value&&this.value.charAt(this.value.length-1)!=this.separator&&(this.value+=this.separator),this.element.value=this.value,this._valueSyncedWithInputField=!0);var e=this.showPopup;""===this.value&&(e=!1),e?(this.popup.show(),this.activeItemIndex=0):this.popup&&this.popup.displayed&&this.popup.hide();var t="loading"===this.loadingStatus;this.element.classList[t?"add":"remove"]("matte-Autocomplete--loading")}},handleKeyup:{enumerable:!1,value:function(e){var t=e.keyCode,r=this._getPopup();switch(t){case KEY_DOWN:if(r.displayed){var n=this.suggestions||[];n.length>0&&this.activeItemIndex<n.length-1?this.activeItemIndex++:this.activeItemIndex=0}else r.show(),this.activeItemIndex=0;break;case KEY_UP:r.displayed===!0&&(this.activeItemIndex>0?this.activeItemIndex--:this.activeItemIndex=0);break;case KEY_ENTER:r.displayed===!0?(this.resultsController.selection=[this.suggestions[this.activeItemIndex]],e.preventDefault()):this.suggestedValue=this.tokens[this.tokens.length-1]}this.element.focus()}}});